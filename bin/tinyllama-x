#!/usr/bin/env bash
set -euo pipefail

# tinyllama-x CLI launcher
# Resolves install dir (env override -> system -> user), tolerating case variants.
resolve_app_dir() {
  local candidate
  # 1) Explicit override
  if [[ -n "${TINYLLAMA_X_DIR:-}" && -d "$TINYLLAMA_X_DIR" ]]; then
    echo "$TINYLLAMA_X_DIR"; return 0
  fi
  # 2) System locations
  for candidate in \
    "/opt/TinyLlama-X" \
    "/opt/tinyllama-x"; do
    [[ -d "$candidate" ]] && { echo "$candidate"; return 0; }
  done
  # 3) User locations
  for candidate in \
    "$HOME/.local/share/TinyLlama-X" \
    "$HOME/.local/share/tinyllama-x"; do
    [[ -d "$candidate" ]] && { echo "$candidate"; return 0; }
  done
  return 1
}

APP_DIR="$(resolve_app_dir || true)"
if [[ -z "$APP_DIR" ]]; then
  echo "Error: TinyLlama-X is not installed. Try: bash scripts/install_ubuntu.sh --user" >&2
  exit 1
fi

# Prefer the auto-updating script; fallback to simple
find_entry() {
  local name="$1"; shift || true
  local p
  for p in \
    "$APP_DIR/tinyllama-x/tinyllama-x/$name" \
    "$APP_DIR/tinyllama-x/$name" \
    "$APP_DIR/$name"; do
    [[ -x "$p" && -s "$p" ]] && { echo "$p"; return 0; }
  done
  return 1
}

if entry="$(find_entry ai_terminal_llama_auto.sh)"; then
  exec "$entry" "$@"
elif entry="$(find_entry ai_terminal_llama_simple.sh)"; then
  exec "$entry" "$@"
else
  echo "Error: Launch scripts not found under $APP_DIR" >&2
  exit 1
fi
